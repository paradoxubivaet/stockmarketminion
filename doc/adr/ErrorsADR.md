# Стратегия работы с исключениями.  
by ted7007

**Описание проблемы:**  
У команды нет общего представления работы с исключениями в проекте.

---  

**Цель:**
Необходимо выделить общее решение работы с исключениями -
* как их генерировать
* как их обрабатывать
* в каком виде они передаются в grpc методах
---

**Решение:**  

**Global exception handler**  
Решение заключается в использовании глобального обработчика исключениями. 

Суть этого варианта заключается в том, что мы создаем middleware обработчик исключений и вставляем его в начало нашего конвейера обработки запроса (pipeline).  
Также в клиентах grpc сервисов тоже создаем обработчики исключений ( в случае нашего проекта это будет только на фасаде ).  

В обработчиках мы можем логгировать системные/программистские ошибки генерировать и по ним rpc exceptions.  

Альтернативой глобальной обработке событий является обертка try/catch в ~~контроллерах~~ rpc методах. 

Глобальная обработка исключений имеет следующие преимущества по отношению к обертке всех rpc методов:  
* Читабельность, все обработки исключений централизованы и не засоряют наши методы.
* Из предыдущего пункта следует то, что мы можем вынести в такие обработчики например логгирование, или копи паст какого-то действия с конкретным типом исключений  

> следует понимать, что бывает необходимость обрабатывать исключения внутри нашего приложения, глобальный обработчик не предназначен для таких узких обработок.  
[Пример обработчиков исключений в grpc](https://anthonygiretti.com/2020/03/31/grpc-asp-net-core-3-1-global-error-handling-in-grpc-grpc-status-codes/)  

**Validation**  
Помимо програмистских и системных ошибок выделяют также ошибки ввода. 
В нашем случае это невалидные rpc сообщения, которые могут прийти от клиента (пустая строка/невалидный id/отрицательная сумма и т.п.)  

С этой задачей может справиться библиотечка для валидации grpc сообщений, где лаконично можно создать правила для каждого сообщения (классы валидаторы),
а затем добавить их разом  
```csharp  
services.AddValidators();
```

Альтернативным примитивным решением будет валидирование входящих сообщений вместе с бизнес валидацией  

Примущество использования вышеупомянутой библиотеки заключается в меньшем количестве кода, читабельности и в разделении валидации невалидных сообщений от бизнес  валидации.  


[Примеры валидаторов](https://anthonygiretti.com/2020/05/18/grpc-asp-net-core-3-1-model-validation/)  

---  

Дополнительно предлагается ввести обязательное логгирование ошибок в глобальном обработчике,  
валидирование всех сообщений в валидаторе.
